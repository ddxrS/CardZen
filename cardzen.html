<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Card Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            color: #374151;
            user-select: none;
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .card.selected {
            border-color: #3b82f6;
            transform: translateY(-12px);
        }
        /* Custom Animations */
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        }
        .perfect-explosion {
            animation: pulse-green 0.5s ease-out;
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col">

    <!-- App Container -->
    <div id="app" class="flex-1 flex flex-col relative max-w-5xl mx-auto w-full h-full bg-white shadow-xl">
        
        <!-- Navigation / Header -->
        <header class="h-16 border-b border-gray-100 flex items-center justify-between px-6 bg-white z-10">
            <h1 class="text-xl font-bold tracking-tight text-gray-800">Card<span class="text-blue-500">Zen</span></h1>
            <div id="header-stats" class="hidden flex gap-6 text-sm font-medium text-gray-600">
                <span id="money-display" class="flex items-center gap-1 text-yellow-600">
                    <span>ğŸª™</span> <span id="money-val">0</span>
                </span>
            </div>
        </header>

        <!-- Views Container -->
        <main class="flex-1 relative overflow-hidden">
            
            <!-- VIEW: Main Menu -->
            <div id="view-menu" class="absolute inset-0 flex flex-col items-center justify-center space-y-8 p-4">
                <div class="text-center space-y-2">
                    <h2 class="text-4xl font-light text-gray-800">ç­–ç•¥å¡ç‰Œ</h2>
                    <p class="text-gray-400">ç®€çº¦é£æ ¼ â€¢ ç­–ç•¥é—¯å…³</p>
                </div>
                <div class="space-y-3 w-64">
                    <button onclick="game.showLevelSelect()" class="w-full py-3 bg-gray-900 text-white rounded-lg hover:bg-gray-700 transition shadow-lg">å¼€å§‹æ¸¸æˆ</button>
                    <button onclick="game.showShop()" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition">é“å…·å•†åº—</button>
                    <button onclick="game.showAchievements()" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition">æˆå°±ç³»ç»Ÿ</button>
                    <button onclick="game.showRules()" class="w-full py-3 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition">æ¸¸æˆè§„åˆ™</button>
                </div>
            </div>

            <!-- VIEW: Level Select -->
            <div id="view-levels" class="absolute inset-0 hidden flex-col p-6 overflow-y-auto bg-gray-50">
                <div class="flex justify-between items-center mb-6 flex-none">
                    <h3 class="text-2xl font-light">é€‰æ‹©å…³å¡</h3>
                    <button onclick="game.showMenu()" class="text-gray-500 hover:text-gray-800">è¿”å›</button>
                </div>
                <div id="level-container" class="space-y-8 pb-10">
                    <!-- Levels generated by JS grouped by type -->
                </div>
            </div>

            <!-- VIEW: Achievements -->
            <div id="view-achievements" class="absolute inset-0 hidden flex-col p-6 overflow-y-auto bg-gray-50">
                <div class="flex justify-between items-center mb-6 flex-none">
                    <h3 class="text-2xl font-light">æˆå°±ç³»ç»Ÿ</h3>
                    <button onclick="game.showMenu()" class="text-gray-500 hover:text-gray-800">è¿”å›</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="achievement-list">
                    <!-- Rendered by JS -->
                </div>
            </div>

            <!-- VIEW: Shop & Loadout -->
            <div id="view-shop" class="absolute inset-0 hidden flex-col p-6 overflow-y-auto bg-gray-50">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-light">é“å…·å•†åº— & é…ç½®</h3>
                    <button onclick="game.showMenu()" class="text-gray-500 hover:text-gray-800">è¿”å›</button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <!-- Shop Items -->
                    <div class="lg:col-span-2 space-y-4">
                        <h4 class="font-medium text-gray-500 uppercase text-xs tracking-wider">å•†åº—</h4>
                        <div id="shop-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Shop items generated by JS -->
                        </div>
                    </div>
                    
                    <!-- Current Loadout -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                        <h4 class="font-medium text-gray-500 uppercase text-xs tracking-wider mb-4">å½“å‰æºå¸¦ (æœ€å¤§3ä¸ª)</h4>
                        <div id="loadout-list" class="space-y-2 flex-1">
                            <!-- Selected items -->
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 text-center text-sm text-gray-400">
                            ç‚¹å‡»å·¦ä¾§å•†åº—è´­ä¹°ï¼Œç‚¹å‡»ä¸Šæ–¹ç§»é™¤
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: Game Interface -->
            <div id="view-game" class="absolute inset-0 hidden flex flex-col bg-slate-50">
                <!-- Top Info Bar -->
                <div class="h-14 flex items-center justify-between px-6 bg-white border-b border-slate-100 shadow-sm z-10">
                    <div class="flex items-center gap-6">
                        <button onclick="game.quitLevel()" class="text-gray-400 hover:text-red-500 transition" title="æ”¾å¼ƒå…³å¡">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                        </button>
                        <div class="flex gap-4 text-sm border-l border-gray-200 pl-6">
                            <div class="text-gray-500">å›åˆ: <span id="game-round" class="font-bold text-gray-800">1</span>/<span id="game-max-round">5</span></div>
                            <div class="text-gray-500">å‰©ä½™: <span id="deck-count" class="font-bold text-gray-800">40</span></div>
                        </div>
                    </div>
                    
                    <div class="font-medium text-blue-600 text-sm" id="game-objective">ç›®æ ‡: ...</div>
                    
                    <button onclick="game.endRound()" id="btn-end-round" class="px-4 py-1.5 bg-red-50 text-red-600 text-xs font-bold uppercase tracking-wider rounded hover:bg-red-100 border border-red-100 transition">ç»“æŸå›åˆ</button>
                    <button onclick="game.nextRound()" id="btn-next-round" class="hidden px-4 py-1.5 bg-blue-50 text-blue-600 text-xs font-bold uppercase tracking-wider rounded hover:bg-blue-100 border border-blue-100 transition">ä¸‹ä¸€å›åˆ</button>
                </div>

                <!-- Game Area -->
                <div class="flex-1 relative flex flex-col items-center justify-center p-4">
                    
                    <!-- Special Mechanics Area (Top) -->
                    <div id="mechanic-area" class="w-full flex justify-center mb-4 min-h-[60px]">
                        <!-- Type 3: Counter -->
                        <div id="mech-counter" class="hidden flex flex-col items-center">
                            <div class="text-xs text-gray-400 uppercase tracking-widest mb-1">èƒ½é‡æ± </div>
                            <div class="relative w-64 h-6 bg-gray-200 rounded-full overflow-hidden">
                                <div id="counter-bar" class="absolute left-0 top-0 bottom-0 bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div class="mt-1 font-mono text-sm"><span id="counter-val">0</span> / <span id="counter-limit">10</span></div>
                        </div>
                        
                        <!-- Type 4: System Cards -->
                        <div id="mech-poker" class="hidden flex flex-col items-center w-full">
                            <div class="flex flex-col items-center mb-2">
                                <div class="text-xs text-gray-400 uppercase tracking-widest mb-1">ç³»ç»Ÿæ‰‹ç‰Œ</div>
                                <div id="system-hand" class="flex gap-2 transform scale-90"></div>
                                <div id="system-score" class="mt-1 text-xs font-medium text-gray-500 h-4"></div>
                            </div>
                            
                            <div class="w-full border-t border-gray-100 my-1"></div>

                            <div class="flex flex-col items-center mt-1">
                                <div class="text-xs text-gray-400 uppercase tracking-widest mb-1">æœ¬å±€å·²å‡ºç‰Œ</div>
                                <div id="poker-played-hand" class="flex gap-1 flex-wrap justify-center min-h-[3rem] px-4"></div>
                                <div id="poker-player-score" class="mt-1 text-xs font-medium text-blue-500 h-4"></div>
                            </div>
                        </div>

                        <!-- Hardcore UI: Type 1 -->
                        <div id="mech-hardcore-t1" class="hidden w-full max-w-md bg-white p-2 rounded border border-red-200 text-xs shadow-sm mb-2 font-mono"></div>
                        
                        <!-- Hardcore UI: Type 4 -->
                        <div id="mech-hardcore-t4" class="hidden flex flex-col items-center w-full mb-2">
                             <div class="flex gap-8 text-lg font-bold mb-2">
                                 <div class="text-blue-600">æˆ‘æ–¹ç­¹ç : <span id="p-chips">7</span></div>
                                 <div class="text-red-600">å¯¹æ–¹ç­¹ç : <span id="s-chips">7</span></div>
                             </div>
                             <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border border-gray-200">
                                 <span class="text-sm font-medium text-gray-600">ä¸‹æ³¨:</span>
                                 <button onclick="game.setBet(1)" id="btn-bet-1" class="px-4 py-1 bg-white border border-gray-200 rounded hover:bg-blue-50 hover:text-blue-600 font-bold transition ring-2 ring-blue-500">1</button>
                                 <button onclick="game.setBet(2)" id="btn-bet-2" class="px-4 py-1 bg-white border border-gray-200 rounded hover:bg-blue-50 hover:text-blue-600 font-bold transition">2</button>
                             </div>
                        </div>
                        
                        <!-- Hardcore UI: Type 5 -->
                        <div id="mech-hardcore-t5" class="hidden w-full max-w-md mb-2">
                             <div class="flex justify-between text-xs mb-1 font-bold">
                                 <span class="text-red-500">HP: <span id="hp-val">10</span></span>
                                 <span class="text-orange-500">æ—¶é—´: <span id="timer-val">5.0</span>s</span>
                             </div>
                             <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden mb-1">
                                 <div id="hp-bar" class="bg-red-500 h-full w-full transition-all duration-300"></div>
                             </div>
                             <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                                 <div id="timer-bar" class="bg-orange-400 h-full w-full transition-all duration-100 ease-linear"></div>
                             </div>
                             <div class="text-[10px] text-center text-gray-400 mt-1">æ³¨æ„ï¼šæ‰“å‡ºçº¢è‰²ç‰Œæˆ–è¶…æ—¶å°†æ‰£é™¤ 1 ç‚¹ç”Ÿå‘½</div>
                        </div>
                    </div>

                    <!-- Center Board: Last Played Card -->
                    <div class="flex items-center gap-8 mb-8">
                         <div class="relative">
                            <div class="text-xs text-gray-400 uppercase tracking-widest text-center mb-2 absolute -top-6 w-full">ä¸Šä¸€å¼ ç‰Œ</div>
                            <div id="last-card-slot" class="w-24 h-36 bg-gray-200 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400">
                                ç©º
                            </div>
                         </div>
                    </div>

                    <!-- Message/Feedback -->
                    <div id="game-message" class="h-6 text-sm font-medium text-red-500 transition-opacity opacity-0"></div>

                </div>

                <!-- Bottom Player Area -->
                <div class="bg-white border-t border-gray-100 p-4 pb-6 shadow-[0_-5px_20px_rgba(0,0,0,0.02)] z-20">
                    <!-- Items Bar -->
                    <div id="active-items" class="flex justify-center gap-2 mb-4">
                        <!-- Items rendered here -->
                    </div>

                    <!-- Hand -->
                    <div class="flex flex-col items-center">
                        <div class="w-full max-w-2xl flex justify-end mb-1 px-4">
                            <button onclick="game.sortHand()" class="text-xs flex items-center gap-1 text-gray-400 hover:text-blue-500 transition py-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                                </svg>
                                æŒ‰ç‚¹æ•°æ’åº
                            </button>
                        </div>
                        <div id="player-hand" class="flex gap-2 flex-wrap justify-center min-h-[144px]">
                            <!-- Cards rendered here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Result Modal -->
            <div id="modal-result" class="absolute inset-0 hidden z-50 bg-white/90 backdrop-blur-sm flex items-center justify-center">
                <div class="bg-white p-8 rounded-2xl shadow-2xl border border-gray-100 max-w-sm w-full text-center">
                    <div id="result-icon" class="text-6xl mb-4">ğŸ‰</div>
                    <h2 id="result-title" class="text-2xl font-bold mb-2 text-gray-800">èƒœåˆ©!</h2>
                    <p id="result-desc" class="text-gray-600 mb-6">å®Œæˆç›®æ ‡ï¼Œè·å¾— 50 é‡‘å¸</p>
                    <button onclick="game.finishLevel()" class="w-full py-3 bg-gray-900 text-white rounded-lg hover:bg-gray-700 transition">ç»§ç»­</button>
                </div>
            </div>

            <!-- Rules Modal -->
            <div id="modal-rules" class="absolute inset-0 hidden z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 max-w-2xl w-full flex flex-col max-h-[90vh]">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                        <h3 class="text-xl font-bold text-gray-800">æ¸¸æˆè§„åˆ™è¯´æ˜</h3>
                        <button onclick="document.getElementById('modal-rules').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>
                    <div class="p-6 overflow-y-auto space-y-6 text-sm text-gray-600">
                        
                        <section>
                            <h4 class="font-bold text-gray-900 text-base mb-2">ğŸƒ åŸºç¡€ç©æ³•</h4>
                            <p class="mb-2">ç›®æ ‡æ˜¯åœ¨æ‰‹ç‰Œä¸­æ‰“å‡ºå¡ç‰Œï¼Œæ¯å›åˆå¼€å§‹æ—¶ï¼Œè‹¥æ‰‹ç‰Œä¸è¶³ 5 å¼ ä¼šè‡ªåŠ¨è¡¥é½ã€‚ç‰Œå †ç”¨å®Œåä¼šè‡ªåŠ¨é‡æ´—å¼ƒç‰Œå †ã€‚</p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li>å‡ºç‰Œé™åˆ¶ï¼šæ‰“å‡ºçš„ç‰Œå¿…é¡»ä¸<b>ä¸Šä¸€å¼ ç‰Œ</b>é¢œè‰²ç›¸åŒï¼Œæˆ–è€…ç‚¹æ•°å·®è·åœ¨ <b>1</b> ä»¥å†…ã€‚</li>
                                <li><b>ä¸‡èƒ½ç‰Œ (X)</b>ï¼šå¯ä»¥åœ¨ä»»æ„ç‰Œåæ‰“å‡ºï¼Œä¸”ä¹‹åå¯æ¥ä»»æ„ç‰Œã€‚</li>
                                <li><b>å›åˆåˆ¶</b>ï¼šå½“æ— æ³•å‡ºç‰Œæˆ–ä¸æƒ³å‡ºç‰Œæ—¶ï¼Œç‚¹å‡»"ç»“æŸå›åˆ"ã€‚å›åˆç»“æŸä¼šä¸¢å¼ƒæ‰€æœ‰æ‰‹ç‰Œï¼ˆåŒ…æ‹¬è™šæ— ç‰Œï¼‰å¹¶é‡æ–°æŠ½ç‰Œã€‚</li>
                                <li><b>å®Œç¾é€šå…³</b>ï¼šåœ¨ä¸ä½¿ç”¨ä»»ä½•é“å…·çš„æƒ…å†µä¸‹é€šå…³ï¼Œå¯è·å¾—å®Œç¾é€šå…³æ ‡è®°ã€‚</li>
                            </ul>
                        </section>

                        <section>
                            <h4 class="font-bold text-gray-900 text-base mb-2">ğŸ® å…³å¡æ¨¡å¼</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded border border-gray-100">
                                    <div class="font-bold text-blue-600 mb-1">Type 1: åŸºç¡€æŒ‘æˆ˜</div>
                                    <p>åœ¨é™åˆ¶å›åˆå†…æ‰“å‡ºæŒ‡å®šæ•°é‡çš„ç‰Œã€‚</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border border-gray-100">
                                    <div class="font-bold text-blue-600 mb-1">Type 2: X å…ƒç´ </div>
                                    <p>ä¸“æ³¨äºå¯»æ‰¾å¹¶æ‰“å‡ºç¨€æœ‰çš„ X ç‰Œã€‚</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border border-gray-100">
                                    <div class="font-bold text-blue-600 mb-1">Type 3: èƒ½é‡çˆ†ç‚¸</div>
                                    <p>ç´¯ç§¯ç‚¹æ•°ã€‚æ­£å¥½è¾¾åˆ°ä¸Šé™è§¦å‘"å®Œç¾çˆ†ç‚¸"(å¾—åˆ†)ï¼Œè¶…è¿‡åˆ™"çˆ†ç‚¸"(ä¸å¾—åˆ†å¹¶å–æ¨¡)ã€‚</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border border-gray-100">
                                    <div class="font-bold text-blue-600 mb-1">Type 4: åšå¼ˆå¯¹å†³</div>
                                    <p>ç±»ä¼¼å¾·å·æ‰‘å…‹ã€‚å‡‘å‡ºæ¯”ç³»ç»Ÿæ›´å¼ºçš„ 5 å¼ ç‰Œå‹ï¼ˆé¡ºå­ã€åŒèŠ±ã€è‘«èŠ¦ç­‰ï¼‰ã€‚</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border border-gray-100">
                                    <div class="font-bold text-blue-600 mb-1">Type 5: æ—¶é—´è…æœ½</div>
                                    <p>æ¯æ‰“å‡ºä¸€å¼ ç‰Œï¼Œæ‰‹ç‰Œç‚¹æ•° -1ã€‚å‡è‡³ 0 å˜ä¸º"è™šæ— ç‰Œ"ã€‚</p>
                                </div>
                            </div>
                        </section>
                        
                        <section>
                            <h4 class="font-bold text-gray-900 text-base mb-2">ğŸ”¥ ç¡¬æ ¸æ¨¡å¼</h4>
                            <div class="bg-red-50 p-3 rounded border border-red-100 space-y-2">
                                <p class="font-bold text-red-600">âš ï¸ ç¡¬æ ¸æ¨¡å¼æ‹¥æœ‰ç‰¹æ®Šè§„åˆ™ï¼Œéš¾åº¦æé«˜ï¼</p>
                                <ul class="list-disc pl-5 space-y-1 text-gray-600">
                                    <li><b>ç±»å‹ä¸€</b>ï¼šéœ€è¦æŒ‰é¡ºåºå®Œæˆ6ä¸ªè¿ç»­æŒ‘æˆ˜ã€‚</li>
                                    <li><b>ç±»å‹äºŒ</b>ï¼šå¿…é¡»è¿ç»­æ‰“å‡ºä¸¤å¼ Xç‰Œæ‰èƒ½è®¡æ•°ã€‚</li>
                                    <li><b>ç±»å‹å››</b>ï¼šæš—ç‰Œåšå¼ˆï¼Œç­¹ç å¯¹å†³ã€‚ç³»ç»Ÿæ‰‹ç‰Œéšè—ï¼Œæ¯å›åˆéœ€ä¸‹æ³¨1æˆ–2ç­¹ç ã€‚</li>
                                    <li><b>ç±»å‹äº”</b>ï¼šç”Ÿå‘½å€¼ä¸æ—¶é—´é™åˆ¶ã€‚çº¢è‰²ç‰Œå’Œè¶…æ—¶éƒ½ä¼šæ‰£é™¤ç”Ÿå‘½å€¼ã€‚</li>
                                </ul>
                            </div>
                        </section>
                        
                        <section>
                            <h4 class="font-bold text-gray-900 text-base mb-2">ğŸ›ï¸ é“å…·ç³»ç»Ÿ</h4>
                            <p>é€šå…³è·å¾—é‡‘å¸ï¼Œåœ¨å•†åº—è´­ä¹°é“å…·ã€‚æ¯å±€æ¸¸æˆæœ€å¤šæºå¸¦ 3 ä¸ªé“å…·ã€‚</p>
                        </section>
                    </div>
                    <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl text-center">
                        <button onclick="document.getElementById('modal-rules').classList.add('hidden')" class="px-8 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">æ˜ç™½äº†</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        /**
         * Game Constants & Config
         */
        const COLORS = ['red', 'yellow', 'blue', 'green'];
        const COLOR_MAP = {
            'red': { bg: 'bg-rose-500', text: 'text-white', border: 'border-rose-600' },
            'yellow': { bg: 'bg-amber-400', text: 'text-amber-900', border: 'border-amber-500' },
            'blue': { bg: 'bg-blue-500', text: 'text-white', border: 'border-blue-600' },
            'green': { bg: 'bg-emerald-500', text: 'text-white', border: 'border-emerald-600' },
            'void': { bg: 'bg-gray-800', text: 'text-gray-500', border: 'border-gray-900' },
            'x': { bg: 'bg-purple-600', text: 'text-white', border: 'border-purple-700' } // Wildcard
        };

        const ITEMS_DB = {
            'color_change': { name: 'ç™¾å˜ç‰Œ', desc: 'å°†æ‰‹ç‰Œå…¨å˜ä¸ºæŒ‡å®šé¢œè‰²', price: 60, maxUses: 1 },
            'draw_3': { name: 'ç™¾å®ç®±', desc: 'æ‘¸ 3 å¼ ç‰Œ', price: 90, maxUses: 2 },
            'restore': { name: 'æ¢å¤è¯æ°´', desc: 'æ¢å¤ä¸€ä¸ªé“å…·çš„æ¬¡æ•°', price: 70, maxUses: 1 },
            'reset_prev': { name: 'é—å¿˜ä¹‹å°˜', desc: 'æ— è§†ä¸Šä¸€å¼ ç‰Œçš„é™åˆ¶', price: 50, maxUses: 2 },
            'shuffle_hand': { name: 'é‡é“¸æ‰‹å¥—', desc: 'éšæœºé‡ç½®æ‰‹ç‰Œç‚¹æ•°', price: 40, maxUses: 3 },
            'extra_round': { name: 'æ—¶é—´æ²™æ¼', desc: 'å›åˆä¸Šé™ +1', price: 120, maxUses: 1 },
            'add_x': { name: 'è™šç©ºå¬å”¤', desc: 'è·å¾—ä¸€å¼  X ç‰Œ', price: 80, maxUses: 2 },
            'upgrade_val': { name: 'å¼ºåŒ–ç¬¦æ–‡', desc: 'æ‰‹ç‰Œç‚¹æ•°å…¨éƒ¨ +2 (ä¸Šé™10)', price: 70, maxUses: 2 },
            'reshuffle_deck': { name: 'è½®å›ä¹‹åŒ™', desc: 'ç«‹å³é‡æ´—å¼ƒç‰Œå †å›ç‰Œåº“', price: 40, maxUses: 2 },
            'double_draw': { name: 'è´ªå©ªä¹‹å£¶', desc: 'ä¸‹ä¸€æ¬¡æ‘¸ç‰Œæ•°é‡ç¿»å€', price: 60, maxUses: 1 },
            'filter_color': { name: 'æ»¤é•œçœ¼é•œ', desc: 'å¼ƒæ‰æ‰‹ç‰Œä¸­æ‰€æœ‰æŒ‡å®šé¢œè‰²çš„ç‰Œ', price: 50, maxUses: 2 },
            'point_swap': { name: 'å¤©å¹³', desc: 'äº¤æ¢æ‰‹ç‰Œä¸­æœ€å¤§å’Œæœ€å°ç‰Œçš„å€¼', price: 80, maxUses: 3 },
            'emergency_x': { name: 'æ•‘æ€¥åŒ…', desc: 'åœ¨ç‰Œå †é¡¶å¡å…¥ä¸€å¼ X', price: 100, maxUses: 1 },
            // High Value Items
            'void_purifier': { name: 'å‡€åŒ–ä¹‹å…‰', desc: 'ç§»é™¤æ‰‹ç‰Œä¸­æ‰€æœ‰çš„è™šæ— ç‰Œ', price: 200, maxUses: 2 },
            'omnipotent_hand': { name: 'ç‚¹çŸ³æˆé‡‘', desc: 'å°†å½“å‰æ‰‹ç‰Œå…¨éƒ¨å˜ä¸º X ç‰Œ', price: 350, maxUses: 1 },
            'time_freeze': { name: 'æ—¶ç©ºå†»ç»“', desc: 'æœ¬å›åˆä¸æ¶ˆè€—å›åˆæ•°ï¼Œä¸”è¿›åº¦+2', price: 400, maxUses: 1 },
            'golden_ticket': { name: 'VIPé€šè¡Œè¯', desc: 'ç›´æ¥èµ¢å¾—å½“å‰å…³å¡', price: 999, maxUses: 1 }
        };

        const ACHIEVEMENTS = [
            { id: 'first_win', name: 'åˆéœ²é”‹èŠ’', desc: 'å®Œæˆç¬¬1å…³', icon: 'ğŸŒ±' },
            { id: 'perfect_5', name: 'å®Œç¾ä¸»ä¹‰è€…', desc: 'è¾¾æˆ5æ¬¡å®Œç¾é€šå…³', icon: 'â­' },
            { id: 'rich_man', name: 'è…°ç¼ ä¸‡è´¯', desc: 'ç´¯è®¡æŒæœ‰è¶…è¿‡1000é‡‘å¸', icon: 'ğŸ’°' },
            { id: 'card_master', name: 'å‘ç‰Œå‘˜', desc: 'ç´¯è®¡æ‰“å‡º500å¼ ç‰Œ', icon: 'ğŸ´' },
            { id: 'explorer', name: 'æ¢é™©å®¶', desc: 'å®Œæˆ10ä¸ªä¸åŒå…³å¡', icon: 'ğŸš©' },
            { id: 'speedrunner', name: 'ç¥é€Ÿ', desc: 'åªç”¨1ä¸ªå›åˆå®Œæˆä»»æ„å…³å¡', icon: 'âš¡' },
            { id: 'collector', name: 'æ”¶è—å®¶', desc: 'è´­ä¹°æ‰€æœ‰ç§ç±»çš„é“å…·', icon: 'ğŸ' },
            { id: 'big_spender', name: 'æŒ¥é‡‘å¦‚åœŸ', desc: 'åœ¨å•†åº—ç´¯è®¡æ¶ˆè´¹è¶…è¿‡2000é‡‘å¸', icon: 'ğŸ’¸' },
            { id: 'boom_master', name: 'çˆ†ç ´ä¸“å®¶', desc: 'ç´¯è®¡è§¦å‘30æ¬¡å®Œç¾çˆ†ç‚¸', icon: 'ğŸ’¥' },
            { id: 'poker_face', name: 'èµŒç¥', desc: 'åœ¨åšå¼ˆå¯¹å†³ä¸­è·èƒœ50æ¬¡', icon: 'ğŸƒ' },
            { id: 'speedrunner_elite', name: 'ç¥é€Ÿå¤§å¸ˆ', desc: 'åœ¨5ä¸ªä¸åŒå…³å¡è¾¾æˆç¥é€Ÿæˆå°±', icon: 'ğŸ†' }
        ];

        /**
         * Core Game State
         */
        class Game {
            constructor() {
                // Persistent Data
                this.money = 200;
                this.inventory = {}; 
                this.boughtItems = []; 
                this.loadout = []; 
                this.completedLevels = []; 
                this.perfectLevels = []; 
                this.stats = { totalCards: 0, totalWins: 0, explosions: 0, totalSpent: 0, totalBooms: 0, pokerWins: 0, speedrunLevelIds: [] };

                // Runtime State
                this.activeItems = []; 
                this.level = null;
                this.deck = [];
                this.hand = [];
                this.discard = []; 
                this.turn = 1;
                this.round = 1;
                this.progress = 0; 
                this.usedItem = false;
                
                // Specific Mechanics State
                this.counter = 0; 
                this.counterLimit = 10;
                this.systemHand = []; 
                this.roundPlayedCards = []; 
                this.ignoreNextRestriction = false; 

                // Hardcore State
                this.hardcoreState = {
                    t1_step: 0,
                    t1_progress: 0,
                    t4_p_chips: 7,
                    t4_s_chips: 7,
                    t4_bet: 1,
                    t5_hp: 10,
                    t5_timer: null,
                    t5_time_left: 5
                };

                this.loadProgress();
                this.initUI();
            }

            initUI() {
                this.updateMoney();
                this.renderLevelSelect();
            }

            loadProgress() {
                try {
                    const data = localStorage.getItem('zen-card-save-v2');
                    if (data) {
                        const parsed = JSON.parse(data);
                        this.money = parsed.money ?? 200;
                        this.boughtItems = parsed.boughtItems || [];
                        this.loadout = parsed.loadout || [];
                        this.completedLevels = parsed.completedLevels || [];
                        this.perfectLevels = parsed.perfectLevels || [];
                        this.stats = parsed.stats || { totalCards: 0, totalWins: 0, explosions: 0 };
                    }
                } catch (e) {
                    console.error("Save load failed", e);
                }
            }

            saveProgress() {
                const data = {
                    money: this.money,
                    boughtItems: this.boughtItems,
                    loadout: this.loadout,
                    completedLevels: this.completedLevels,
                    perfectLevels: this.perfectLevels,
                    stats: this.stats
                };
                localStorage.setItem('zen-card-save-v2', JSON.stringify(data));
            }

            /* --- Navigation --- */
            
            showMenu() { this.switchView('view-menu'); }
            showLevelSelect() { this.renderLevelSelect(); this.switchView('view-levels'); }
            showShop() { this.renderShop(); this.switchView('view-shop'); }
            showAchievements() { this.renderAchievements(); this.switchView('view-achievements'); }
            showRules() { document.getElementById('modal-rules').classList.remove('hidden'); }
            
            switchView(id) {
                document.querySelectorAll('main > div').forEach(el => {
                    if(!el.id.startsWith('modal')) el.classList.add('hidden');
                });
                document.getElementById(id).classList.remove('hidden');
                document.getElementById('header-stats').style.display = (id !== 'view-menu') ? 'flex' : 'none';
            }

            quitLevel() {
                if(confirm('ç¡®å®šè¦æ”¾å¼ƒå½“å‰å…³å¡å—ï¼Ÿ')) {
                    this.showLevelSelect();
                }
            }

            updateMoney() {
                document.getElementById('money-val').innerText = this.money;
            }

            /* --- Level System --- */

            getLevels() {
                return [
                    // Type 1: Basic
                    { id: 1, type: 1, name: "åˆå…¥ç‰Œå±€", desc: "åŸºç¡€ç»ƒä¹ ï¼šåœ¨5å›åˆå†…æ‰“å‡º12å¼ ç‰Œ", target: 12, rounds: 5, reward: 30 },
                    { id: 2, type: 1, name: "å¾ªåºæ¸è¿›", desc: "åœ¨5å›åˆå†…æ‰“å‡º15å¼ ç‰Œ", target: 15, rounds: 5, reward: 40 },
                    { id: 3, type: 1, name: "è¡Œäº‘æµæ°´", desc: "åœ¨5å›åˆå†…æ‰“å‡º18å¼ ç‰Œ", target: 18, rounds: 5, reward: 50 },
                    { id: 4, type: 1, name: "é«˜é€Ÿè¿è½¬", desc: "åœ¨4å›åˆå†…æ‰“å‡º16å¼ ç‰Œ", target: 16, rounds: 4, reward: 55 },
                    { id: 5, type: 1, name: "æé™è¿å‡»", desc: "é«˜éš¾åº¦ï¼šåœ¨4å›åˆå†…æ‰“å‡º20å¼ ç‰Œ", target: 20, rounds: 4, reward: 60 },
                    { id: 6, type: 1, name: "é©¬æ‹‰æ¾", desc: "é•¿çº¿ä½œæˆ˜ï¼šåœ¨10å›åˆå†…æ‰“å‡º50å¼ ç‰Œ (åˆå§‹ç‰Œå †3å€)", target: 50, rounds: 10, reward: 180, deck_scale: 3 },

                    // Type 2: X Factor
                    { id: 7, type: 2, name: "Xçš„å‘ç°", desc: "å¯»æ‰¾å¹¶ä½¿ç”¨3å¼ Xç‰Œï¼Œå…±æœ‰6å¼ X", target: 3, rounds: 6, x_count: 6, reward: 50 },
                    { id: 8, type: 2, name: "ç¥ç§˜ç¬¦å·", desc: "æ‰“å‡º4å¼ Xç‰Œï¼Œç‰Œå †6å¼ X", target: 4, rounds: 7, x_count: 6, reward: 60 },
                    { id: 9, type: 2, name: "ç¨€æœ‰å…ƒç´ ", desc: "æ‰“å‡º4å¼ Xç‰Œï¼Œç‰Œå †ä»…æœ‰5å¼ X", target: 4, rounds: 8, x_count: 5, reward: 70 },
                    { id: 10, type: 2, name: "å¤§æµ·æé’ˆ", desc: "æ‰“å‡º3å¼ Xç‰Œï¼Œç‰Œå †ä»…æœ‰3å¼ X", target: 3, rounds: 10, x_count: 3, reward: 100 },
                    { id: 11, type: 2, name: "X-é»‘æ´", desc: "æ‰“å‡º5å¼ Xç‰Œï¼ŒXæå¤šä½†å›åˆå°‘", target: 5, rounds: 5, x_count: 15, reward: 120 },
                    
                    // Type 3: Explosion
                    { id: 12, type: 3, name: "èƒ½é‡æŒæ§", desc: "è§¦å‘3æ¬¡å®Œç¾çˆ†ç‚¸ (ä¸Šé™10)", target: 3, rounds: 8, limit: 10, reward: 80 },
                    { id: 13, type: 3, name: "ç²¾å‡†æ§åˆ¶", desc: "è§¦å‘4æ¬¡å®Œç¾çˆ†ç‚¸ (ä¸Šé™10)", target: 4, rounds: 9, limit: 10, reward: 90 },
                    { id: 14, type: 3, name: "ç²¾å¯†è®¡ç®—", desc: "è§¦å‘4æ¬¡å®Œç¾çˆ†ç‚¸ (ä¸Šé™7)", target: 4, rounds: 10, limit: 7, reward: 100 },
                    { id: 15, type: 3, name: "æ³¢åŠ¨å¼•æ“", desc: "è§¦å‘3æ¬¡å®Œç¾çˆ†ç‚¸ï¼Œä¸Šé™æ¯å›åˆå˜åŒ–ï¼Œæ‰‹ç‰Œä¸Šé™7", target: 3, rounds: 8, limit: 10, dynamic_limit: true, reward: 110, hand_limit: 7 },
                    { id: 16, type: 3, name: "é«˜å‹è¿‡è½½", desc: "è§¦å‘5æ¬¡å®Œç¾çˆ†ç‚¸ï¼Œä¸Šé™åŠ¨æ€å˜åŒ–ï¼Œæ‰‹ç‰Œä¸Šé™7", target: 5, rounds: 12, limit: 8, dynamic_limit: true, reward: 140, hand_limit: 7 },
                    { id: 17, type: 3, name: "æ ¸èšå˜", desc: "è§¦å‘3æ¬¡å®Œç¾çˆ†ç‚¸ (ä¸Šé™20)ï¼Œæ‰‹ç‰Œä¸Šé™7", target: 3, rounds: 12, limit: 20, reward: 200, hand_limit: 7 },

                    // Type 4: Poker
                    { id: 18, type: 4, name: "å¾·å·æ–°æ‰‹", desc: "èµ¢å¾—2ä¸ªå›åˆ (å¤§ç‰Œå †)", target: 2, rounds: 5, reward: 80, deck_scale: 3, max_play_count: 15 },
                    { id: 19, type: 4, name: "å…¥é—¨åšå¼ˆ", desc: "èµ¢å¾—3ä¸ªå›åˆ (å¤§ç‰Œå †)", target: 3, rounds: 6, reward: 100, deck_scale: 3, max_play_count: 15 },
                    { id: 20, type: 4, name: "èƒœè´Ÿå¸ˆ", desc: "èµ¢å¾—4ä¸ªå›åˆ (å¤§ç‰Œå †)", target: 4, rounds: 7, reward: 120, deck_scale: 3, max_play_count: 20 },
                    { id: 21, type: 4, name: "èµŒç‹æŒ‘æˆ˜", desc: "èµ¢å¾—5ä¸ªå›åˆ (å¤§ç‰Œå †)", target: 5, rounds: 7, reward: 150, deck_scale: 3, max_play_count: 20 },
                    { id: 22, type: 4, name: "æœ€ç»ˆåšå¼ˆ", desc: "èµ¢å¾—6ä¸ªå›åˆ (å¤§ç‰Œå †)", target: 6, rounds: 8, reward: 300, deck_scale: 3, max_play_count: 25 },

                    // Type 5: Decay
                    { id: 23, type: 5, name: "æ—¶é—´æµé€", desc: "æ‰“å‡º10å¼ ç‰Œ", target: 10, rounds: 6, reward: 90 },
                    { id: 24, type: 5, name: "è…æœ½åŠ é€Ÿ", desc: "æ‰“å‡º15å¼ ç‰Œ", target: 15, rounds: 7, reward: 100 },
                    { id: 25, type: 5, name: "æ€¥é€Ÿè¡°è´¥", desc: "æ‰“å‡º25å¼ ç‰Œï¼Œå›åˆç´§ç¼º", target: 25, rounds: 7, reward: 120 },
                    { id: 26, type: 5, name: "è™šç©ºä¹‹è§¦", desc: "æ‰“å‡º35å¼ ç‰Œï¼Œæ³¨æ„æ‰‹ç‰Œç®¡ç†", target: 35, rounds: 8, reward: 150 },
                    { id: 27, type: 5, name: "ç†µå¢", desc: "æ‰“å‡º50å¼ ç‰Œï¼Œæéš¾æŒ‘æˆ˜", target: 50, rounds: 10, reward: 200, deck_scale: 2 },

                    // High Difficulty Extensions
                    { id: 28, type: 1, name: "æé™ç”Ÿå­˜", desc: "è¶…é•¿æŒ‘æˆ˜ï¼šåœ¨15å›åˆå†…æ‰“å‡º80å¼ ç‰Œ (åˆå§‹ç‰Œå †3å€)", target: 80, rounds: 15, reward: 350, deck_scale: 3 },
                    { id: 29, type: 2, name: "X-ä¹±èˆ", desc: "å¯»æ‰¾7å¼ Xç‰Œï¼Œæé«˜å¯†åº¦", target: 7, rounds: 10, x_count: 20, reward: 250 },
                    { id: 30, type: 3, name: "ç»å¯¹æŒæ§", desc: "è§¦å‘5æ¬¡å®Œç¾çˆ†ç‚¸ï¼Œæ‰‹ç‰Œä¸Šé™8", target: 5, rounds: 10, limit: 5, reward: 280, hand_limit: 8 },
                    { id: 31, type: 4, name: "èµŒç¥", desc: "èµ¢å¾—7ä¸ªå›åˆ (å¤§ç‰Œå †)", target: 7, rounds: 8, reward: 500, deck_scale: 3, max_play_count: 25 },
                    { id: 32, type: 5, name: "è™šæ— ç»ˆç„‰", desc: "æ‰“å‡º65å¼ ç‰Œ (åˆå§‹ç‰Œå †3å€)", target: 65, rounds: 12, reward: 400, deck_scale: 3 },

                    // Hardcore Modes
                    { id: 33, type: 1, name: "è¯•ç‚¼ä¹‹è·¯", desc: "ç¡¬æ ¸æ¨¡å¼ï¼šæŒ‰é¡ºåºå®Œæˆ6é¡¹è‰°éš¾æŒ‘æˆ˜", hardcore: true, target: 1, rounds: 25, reward: 600, deck_scale: 3 },
                    { id: 34, type: 2, name: "åŒæ˜Ÿè¿ç ", desc: "ç¡¬æ ¸æ¨¡å¼ï¼šæ‰“å‡º5æ¬¡è¿ç»­çš„ä¸¤å¼ Xç‰Œ", hardcore: true, target: 5, rounds: 15, x_count: 30, reward: 600, deck_scale: 2 },
                    { id: 35, type: 4, name: "é»‘æš—æ‰‘å…‹", desc: "ç¡¬æ ¸æ¨¡å¼ï¼šæš—ç‰Œåšå¼ˆï¼Œç­¹ç å¯¹å†³ (åˆå§‹7ç­¹ç )", hardcore: true, target: 1, chips: 7, rounds: 99, reward: 800, deck_scale: 3, max_play_count: 5 },
                    { id: 36, type: 5, name: "ç”Ÿæ­»æ—¶é€Ÿ", desc: "ç¡¬æ ¸æ¨¡å¼ï¼šé™æ—¶å‡ºç‰Œï¼Œçº¢ç‰Œæ‰£è¡€", hardcore: true, target: 40, rounds: 12, hp: 10, time_limit: 5, reward: 800, deck_scale: 2 },
                ];
            }

            renderLevelSelect() {
                const container = document.getElementById('level-container');
                container.innerHTML = '';
                
                const levels = this.getLevels();
                const grouped = levels.reduce((acc, lvl) => {
                    if(!acc[lvl.type]) acc[lvl.type] = [];
                    acc[lvl.type].push(lvl);
                    return acc;
                }, {});

                const TYPE_NAMES = {
                    1: "åŸºç¡€æŒ‘æˆ˜",
                    2: "X å…ƒç´ ",
                    3: "èƒ½é‡çˆ†ç‚¸",
                    4: "åšå¼ˆå¯¹å†³",
                    5: "æ—¶é—´è…æœ½"
                };

                const TYPE_DESC = {
                    1: "åŸºç¡€è§„åˆ™ç»ƒä¹ ä¸è¿›é˜¶",
                    2: "çµæ´»ä½¿ç”¨ä¸‡èƒ½ç‰Œ X",
                    3: "æ§åˆ¶ç‚¹æ•°å‡‘æ•´è§¦å‘çˆ†ç‚¸",
                    4: "ç»„å»ºæœ€å¤§ç‰Œå‹å‡»è´¥ç³»ç»Ÿ",
                    5: "æ‰‹ç‰Œç‚¹æ•°éšå‡ºç‰Œè¡°å‡ï¼Œå½’é›¶åˆ™åºŸå¼ƒ"
                };

                Object.keys(grouped).forEach(type => {
                    const header = document.createElement('div');
                    header.className = "mb-4 mt-8 first:mt-0";
                    header.innerHTML = `
                        <h4 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-2 h-6 bg-blue-500 rounded-full"></span>
                            ${TYPE_NAMES[type]}
                        </h4>
                        <p class="text-sm text-gray-400 ml-4 mt-1">${TYPE_DESC[type]}</p>
                    `;
                    container.appendChild(header);

                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4";
                    
                    grouped[type].forEach(lvl => {
                        const isDone = this.completedLevels.includes(lvl.id);
                        const isPerfect = this.perfectLevels.includes(lvl.id);
                        
                        const el = document.createElement('div');
                        let borderClass = isDone ? 'border-green-200 bg-green-50/30' : 'border-gray-100';
                        let bgClass = 'bg-white';
                        let titleColor = 'text-blue-600';
                        
                        if (lvl.hardcore) {
                            borderClass = isDone ? 'border-red-800 bg-red-50' : 'border-red-200 bg-red-50/10';
                            bgClass = 'bg-red-50/5';
                            titleColor = 'text-red-700';
                        }

                        el.className = `${bgClass} p-5 rounded-xl shadow-sm border ${borderClass} hover:border-red-400 cursor-pointer transition group relative overflow-hidden`;
                        el.onclick = () => this.startLevel(lvl);
                        el.innerHTML = `
                            <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br ${lvl.hardcore ? 'from-red-100 to-white' : 'from-gray-50 to-white'} rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-gray-800">Level ${lvl.id}</span>
                                        ${isDone ? '<span class="text-green-500 text-xs font-bold px-1.5 py-0.5 bg-green-100 rounded-full">âœ“</span>' : ''}
                                        ${isPerfect ? '<span class="text-amber-500 text-xs font-bold" title="å®Œç¾é€šå…³">â­</span>' : ''}
                                    </div>
                                    <span class="text-xs font-mono bg-blue-50 px-2 py-1 rounded text-blue-600 font-bold">${lvl.reward} ğŸª™</span>
                                </div>
                                <h4 class="text-lg ${titleColor} mb-2 font-bold flex items-center gap-2">
                                    ${lvl.name}
                                    ${lvl.hardcore ? '<span class="text-[10px] bg-red-600 text-white px-1.5 py-0.5 rounded uppercase tracking-wider">Hard</span>' : ''}
                                </h4>
                                <p class="text-sm text-gray-500 mb-1 h-10 leading-snug">${lvl.desc}</p>
                            </div>
                        `;
                        grid.appendChild(el);
                    });
                    
                    container.appendChild(grid);
                });
            }

            renderAchievements() {
                const list = document.getElementById('achievement-list');
                list.innerHTML = '';

                const isAchieved = (id) => {
                    switch(id) {
                        case 'first_win': return this.stats.totalWins >= 1;
                        case 'perfect_5': return this.perfectLevels.length >= 5;
                        case 'rich_man': return this.money >= 1000;
                        case 'card_master': return this.stats.totalCards >= 500;
                        case 'explorer': return this.completedLevels.length >= 10;
                        case 'speedrunner': return (this.stats.speedruns || 0) >= 1;
                        case 'collector': return this.boughtItems.length >= Object.keys(ITEMS_DB).length;
                        case 'big_spender': return (this.stats.totalSpent || 0) >= 2000;
                        case 'boom_master': return (this.stats.totalBooms || 0) >= 30;
                        case 'poker_face': return (this.stats.pokerWins || 0) >= 50;
                        case 'speedrunner_elite': return (this.stats.speedrunLevelIds || []).length >= 5;
                        default: return false;
                    }
                };

                ACHIEVEMENTS.forEach(ach => {
                    const done = isAchieved(ach.id);
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-lg border flex items-center gap-4 ${done ? 'bg-white border-amber-200 shadow-sm' : 'bg-gray-50 border-gray-100 grayscale opacity-70'}`;
                    div.innerHTML = `
                        <div class="text-4xl">${ach.icon}</div>
                        <div>
                            <div class="font-bold text-gray-800 flex items-center gap-2">
                                ${ach.name}
                                ${done ? '<span class="text-amber-500 text-xs">âœ“ å·²è¾¾æˆ</span>' : ''}
                            </div>
                            <div class="text-sm text-gray-500">${ach.desc}</div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            /* --- Game Loop --- */

            startLevel(levelConfig) {
                this.level = levelConfig;
                this.switchView('view-game');
                
                // Reset State
                this.deck = this.createDeck();
                this.hand = [];
                this.discard = [];
                this.round = 1;
                this.progress = 0;
                this.counter = 0;
                this.counterLimit = levelConfig.limit || 10;
                this.ignoreNextRestriction = false;
                this.usedItem = false;
                this._hardcoreT4Reveal = false;
                
                // Reset Hardcore State
                if (this.level.hardcore) {
                    if (this.level.type === 1) {
                        this.hardcoreState.t1_step = 0;
                        this.hardcoreState.t1_progress = 0;
                    } else if (this.level.type === 4) {
                        this.hardcoreState.t4_p_chips = this.level.chips || 7;
                        this.hardcoreState.t4_s_chips = this.level.chips || 7;
                        this.hardcoreState.t4_bet = 1;
                    } else if (this.level.type === 5) {
                        this.hardcoreState.t5_hp = this.level.hp || 10;
                        this.hardcoreState.t5_time_left = this.level.time_limit || 5;
                    }
                }

                // Initialize Items
                this.activeItems = this.loadout.map(id => ({
                    id: id,
                    uses: ITEMS_DB[id].maxUses,
                    maxUses: ITEMS_DB[id].maxUses
                }));

                // UI Reset
                document.getElementById('game-max-round').innerText = this.level.rounds;
                this.updateObjectiveUI();
                this.setupMechanicsUI();
                
                this.clearMessage();
                this.startRound();
            }

            clearMessage() {
                const el = document.getElementById('game-message');
                el.innerText = '';
                el.classList.add('opacity-0');
            }

            createDeck() {
                let cards = [];
                const scale = this.level.deck_scale || 1;
                
                for(let s=0; s<scale; s++) {
                    // Standard 40 cards
                    for(let c of COLORS) {
                        for(let i=1; i<=10; i++) {
                            cards.push({ id: Math.random().toString(36), color: c, value: i, type: 'normal' });
                        }
                    }
                    
                    // Add Special Cards based on Level Type
                    if (this.level.type === 2) {
                        const xCount = this.level.x_count || 3;
                        for(let i=0; i<xCount; i++) {
                            cards.push({ id: `x-${i}-${s}`, color: 'x', value: 0, type: 'x' });
                        }
                    }
                }

                return this.shuffle(cards);
            }

            shuffle(array) {
                return array.sort(() => Math.random() - 0.5);
            }

            setupMechanicsUI() {
                document.getElementById('mech-counter').classList.add('hidden');
                document.getElementById('mech-poker').classList.add('hidden');
                document.getElementById('mech-hardcore-t1').classList.add('hidden');
                document.getElementById('mech-hardcore-t4').classList.add('hidden');
                document.getElementById('mech-hardcore-t5').classList.add('hidden');
                
                if (this.level.type === 3) {
                    document.getElementById('mech-counter').classList.remove('hidden');
                    this.updateCounterUI();
                } else if (this.level.type === 4) {
                    document.getElementById('mech-poker').classList.remove('hidden');
                    if (this.level.hardcore) {
                        document.getElementById('mech-hardcore-t4').classList.remove('hidden');
                        this.updateHardcoreT4UI();
                    }
                }
                
                if (this.level.hardcore) {
                    if (this.level.type === 1) {
                        document.getElementById('mech-hardcore-t1').classList.remove('hidden');
                        this.updateHardcoreT1UI();
                    } else if (this.level.type === 5) {
                        document.getElementById('mech-hardcore-t5').classList.remove('hidden');
                        this.startTimerT5();
                    }
                }
            }

            startRound() {
                this.clearMessage();
                this.roundPlayedCards = []; 

                if(this.level.hardcore && this.level.type === 5) {
                    this.startTimerT5();
                }
                
                // Type 4: Generate System Hand
                if (this.level.type === 4) {
                    this.systemHand = [];
                    for(let i=0; i<5; i++) {
                        const c = COLORS[Math.floor(Math.random() * 4)];
                        const v = Math.floor(Math.random() * 5) + 6; 
                        this.systemHand.push({ color: c, value: v, type: 'normal' });
                    }
                    this.updatePokerUI();
                }

                if (this.level.type === 3 && this.level.dynamic_limit) {
                     this.counterLimit = Math.floor(Math.random() * 8) + 5; 
                     this.counter = 0; 
                     this.updateCounterUI();
                }

                this.fillHand();
                this.sortHand();
                this.updateGameUI();
            }

            fillHand() {
                const limit = this.level.hand_limit || 5;

                if (this.deck.length === 0 && this.discard.length > 0) {
                    this.reshuffle();
                }

                while(this.hand.length < limit && this.deck.length > 0) {
                    const card = this.deck.pop();
                    this.hand.push(card);
                    
                    if (this.deck.length === 0 && this.discard.length > 0) {
                        this.reshuffle();
                    }
                }
                
                // å¦‚æœç‰Œå †å’Œå¼ƒç‰Œå †éƒ½ç©ºäº†ï¼Œä¸”æ— æ³•å†æŠ½ç‰Œï¼Œåˆ™ç›´æ¥ç»“æŸå…³å¡
                if (this.hand.length === 0 && this.deck.length === 0 && this.discard.length === 0) {
                    this.failLevel();
                }
            }
            
            reshuffle() {
                 const recycled = this.discard.map(c => {
                     if (c.type === 'void') {
                         return { 
                            id: c.id, 
                            color: COLORS[Math.floor(Math.random()*4)], 
                            value: Math.floor(Math.random()*10)+1, 
                            type: 'normal' 
                         };
                     }
                     return c;
                 });
                 
                 this.deck = this.shuffle(recycled);
                 this.discard = [];
                 this.showMessage("ç‰Œå †è€—å°½ï¼Œå·²é‡æ–°æ´—ç‰Œï¼", "blue");
            }

            sortHand() {
                this.hand.sort((a, b) => {
                    if (a.value !== b.value) return b.value - a.value;
                    return a.color.localeCompare(b.color);
                });
                this.updateGameUI();
            }

            /* --- Player Actions --- */

            playCard(cardIndex) {
                if (this.level.type === 4) {
                    const limit = this.level.max_play_count || 5;
                    if (this.roundPlayedCards.length >= limit) {
                        this.showMessage(`æœ¬å›åˆæœ€å¤šæ‰“å‡º ${limit} å¼ ç‰Œ`);
                        return;
                    }
                }

                const card = this.hand[cardIndex];
                
                if (card.type === 'void') {
                    this.showMessage("è™šæ— ç‰Œæ— æ³•æ‰“å‡ºï¼");
                    return;
                }

                let isValid = false;
                
                if (this.ignoreNextRestriction) {
                    isValid = true;
                } else {
                    const topCard = this.discard.length > 0 ? this.discard[this.discard.length - 1] : null;
                    
                    if (card.type === 'x') isValid = true;
                    else if (!topCard) isValid = true;
                    else if (topCard.type === 'x') isValid = true; 
                    else if (card.color === topCard.color) isValid = true;
                    else if (Math.abs(card.value - topCard.value) <= 1) isValid = true;
                }

                if (!isValid) {
                    this.showMessage("ä¸ç¬¦åˆå‡ºç‰Œè§„åˆ™ï¼");
                    return;
                }

                this.hand.splice(cardIndex, 1);
                this.discard.push(card);
                this.ignoreNextRestriction = false;
                this.roundPlayedCards.push(card);
                
                this.stats.totalCards = (this.stats.totalCards || 0) + 1;

                this.applyGameMechanics(card);
                this.fillHand();
                this.updateGameUI();
                this.checkWinCondition();
            }

            applyGameMechanics(card) {
                const prevCard = this.discard.length >= 2 ? this.discard[this.discard.length - 2] : null;

                // --- Hardcore Logic ---
                if (this.level.hardcore) {
                    // Type 1 Hardcore: Sequential Steps
                    if (this.level.type === 1) {
                        const s = this.hardcoreState;
                        let success = false;
                        
                        switch(s.t1_step) {
                            case 0: // 10 cards
                                s.t1_progress++;
                                if(s.t1_progress >= 10) success = true;
                                break;
                            case 1: // Sum >= 60
                                if(card.type === 'normal') s.t1_progress += card.value;
                                if(s.t1_progress >= 60) success = true;
                                break;
                            case 2: // Diff 1 x5
                                if(prevCard && prevCard.type === 'normal' && card.type === 'normal' && Math.abs(card.value - prevCard.value) === 1) {
                                    s.t1_progress++;
                                }
                                if(s.t1_progress >= 5) success = true;
                                break;
                            case 3: // Equal x3
                                if(prevCard && prevCard.type === 'normal' && card.type === 'normal' && card.value === prevCard.value) {
                                    s.t1_progress++;
                                }
                                if(s.t1_progress >= 3) success = true;
                                break;
                            case 4: // Mod 4 x5 (Continuous 2 cards divisible by 4)
                                if(prevCard && prevCard.type === 'normal' && card.type === 'normal' && prevCard.value % 4 === 0 && card.value % 4 === 0) {
                                     s.t1_progress++;
                                }
                                if(s.t1_progress >= 5) success = true;
                                break;
                            case 5: // Double 10 x2
                                if(prevCard && prevCard.type === 'normal' && card.type === 'normal' && prevCard.value === 10 && card.value === 10) {
                                    s.t1_progress++;
                                }
                                if(s.t1_progress >= 2) success = true;
                                break;
                        }

                        if (success) {
                            s.t1_step++;
                            s.t1_progress = 0;
                            this.showMessage("æŒ‘æˆ˜å®Œæˆï¼è¿›å…¥ä¸‹ä¸€é˜¶æ®µ", "green");
                            if (s.t1_step >= 6) this.progress = this.level.target || 1;
                        }
                        this.updateHardcoreT1UI();
                        return;
                    }

                    // Type 2 Hardcore: Double X
                    if (this.level.type === 2) {
                        if (card.type === 'x' && prevCard && prevCard.type === 'x') {
                            this.progress++;
                            this.showMessage("åŒæ˜Ÿè¿ç ï¼", "purple");
                        }
                        return;
                    }
                    
                    // Type 5 Hardcore: Red Card Penalty & Reset Timer
                    if (this.level.type === 5) {
                        this.startTimerT5();
                        if (card.color === 'red') {
                            this.takeDamage(1, "çº¢è‰²ç‰Œä¼¤å®³");
                        }
                        this.progress++;
                    }
                }

                // --- Standard Logic ---
                if ((this.level.type === 1 || this.level.type === 5) && !this.level.hardcore) {
                    this.progress++;
                }
                
                if (this.level.type === 2 && card.type === 'x' && !this.level.hardcore) {
                    this.progress++;
                }

                if (this.level.type === 3) {
                    let val = card.value;
                    if(card.type === 'x') val = 0; 
                    
                    this.counter += val;
                    if (this.counter === this.counterLimit) {
                        this.progress++;
                        this.stats.totalBooms = (this.stats.totalBooms || 0) + 1;
                        this.counter = 0;
                        this.showMessage("å®Œç¾çˆ†ç‚¸ï¼", "green");
                        document.getElementById('mech-counter').classList.add('perfect-explosion');
                        setTimeout(() => document.getElementById('mech-counter').classList.remove('perfect-explosion'), 500);
                        
                        if(this.level.dynamic_limit) {
                             this.counterLimit = Math.floor(Math.random() * 8) + 5;
                        }

                    } else if (this.counter > this.counterLimit) {
                        this.counter = this.counter % this.counterLimit;
                        this.showMessage("çˆ†ç‚¸ï¼èƒ½é‡æº¢å‡º", "red");
                    }
                    this.updateCounterUI();
                }

                if (this.level.type === 5) {
                    this.hand.forEach(c => {
                        if (c.type !== 'x' && c.type !== 'void') {
                            c.value -= 1;
                            if (c.value <= 0) {
                                c.value = 0;
                                c.type = 'void';
                                c.color = 'void';
                            }
                        }
                    });
                }
            }

            /* --- Items --- */
            
            useItem(itemIndex) {
                const item = this.activeItems[itemIndex];
                if (item.uses <= 0) {
                    this.showMessage("é“å…·æ¬¡æ•°å·²ç”¨å®Œ");
                    return;
                }

                let success = false;
                this.usedItem = true;

                switch(item.id) {
                    case 'color_change':
                        this.hand.forEach(c => {
                            if(c.type === 'normal') {
                                const idx = COLORS.indexOf(c.color);
                                if(idx >= 0) c.color = COLORS[(idx+1)%4];
                            }
                        });
                        this.showMessage("æ‰‹ç‰Œé¢œè‰²å·²å˜æ¢");
                        success = true;
                        break;
                    case 'draw_3':
                        for(let i=0; i<3; i++) {
                             if (this.deck.length === 0 && this.discard.length > 0) this.reshuffle();
                             if(this.deck.length > 0) this.hand.push(this.deck.pop());
                        }
                        success = true;
                        break;
                    case 'reset_prev':
                        this.ignoreNextRestriction = true;
                        this.showMessage("ä¸‹å¼ ç‰Œæ— è§†è§„åˆ™");
                        success = true;
                        break;
                    case 'shuffle_hand':
                        this.hand.forEach(c => {
                            if(c.type === 'normal') c.value = Math.floor(Math.random()*10)+1;
                        });
                        success = true;
                        break;
                    case 'extra_round':
                        this.level.rounds++;
                        document.getElementById('game-max-round').innerText = this.level.rounds;
                        success = true;
                        break;
                    case 'restore':
                        this.activeItems.forEach((it, idx) => {
                            if(idx !== itemIndex) it.uses = it.maxUses;
                        });
                        success = true;
                        break;
                    case 'add_x':
                        this.hand.push({ id: `item-x-${Date.now()}`, color: 'x', value: 0, type: 'x' });
                        this.updateGameUI();
                        success = true;
                        break;
                    case 'upgrade_val':
                        this.hand.forEach(c => {
                            if(c.type === 'normal') {
                                c.value = Math.min(10, c.value + 2);
                            }
                        });
                        this.updateGameUI();
                        success = true;
                        break;
                    case 'reshuffle_deck':
                        this.reshuffle();
                        success = true;
                        break;
                    case 'double_draw':
                        for(let i=0; i<5; i++) {
                            if (this.deck.length === 0 && this.discard.length > 0) this.reshuffle();
                            if(this.deck.length > 0) this.hand.push(this.deck.pop());
                        }
                        this.showMessage("è´ªå©ªä¹‹å£¶ï¼šå·²è¡¥å……æ‰‹ç‰Œ");
                        success = true;
                        break;
                    case 'filter_color':
                         const colorCounts = {};
                         this.hand.forEach(c => { if(c.color) colorCounts[c.color] = (colorCounts[c.color]||0)+1; });
                         const maxColor = Object.keys(colorCounts).sort((a,b)=>colorCounts[b]-colorCounts[a])[0];
                         if(maxColor) {
                             this.hand = this.hand.filter(c => c.color !== maxColor);
                             this.fillHand();
                             this.showMessage(`å·²å¼ƒæ‰æ‰€æœ‰ ${maxColor} ç‰Œ`);
                             success = true;
                         }
                         break;
                    case 'point_swap':
                        if(this.hand.length >= 2) {
                            let minI = 0, maxI = 0;
                            this.hand.forEach((c, i) => {
                                if(c.value < this.hand[minI].value) minI = i;
                                if(c.value > this.hand[maxI].value) maxI = i;
                            });
                            const temp = this.hand[minI].value;
                            this.hand[minI].value = this.hand[maxI].value;
                            this.hand[maxI].value = temp;
                            this.showMessage("æ•°å€¼å·²äº¤æ¢");
                            success = true;
                        }
                        break;
                    case 'emergency_x':
                         this.deck.push({ id: `item-x-${Date.now()}`, color: 'x', value: 0, type: 'x' });
                         this.showMessage("Xç‰Œå·²åŠ å…¥ç‰Œå †é¡¶");
                         success = true;
                         break;
                    case 'void_purifier':
                         const beforeCount = this.hand.length;
                         this.hand = this.hand.filter(c => c.type !== 'void');
                         const removed = beforeCount - this.hand.length;
                         if (removed > 0) {
                             this.fillHand();
                             this.showMessage(`å‡€åŒ–äº† ${removed} å¼ è™šæ— ç‰Œ`, "blue");
                             success = true;
                         } else {
                             this.showMessage("æ‰‹ç‰Œä¸­æ²¡æœ‰è™šæ— ç‰Œ");
                         }
                         break;
                    case 'omnipotent_hand':
                         this.hand.forEach(c => {
                             c.type = 'x';
                             c.color = 'x';
                             c.value = 0;
                             c.id = `omni-${Math.random()}`;
                         });
                         this.showMessage("å…¨å‘˜ X åŒ–ï¼", "purple");
                         success = true;
                         break;
                    case 'time_freeze':
                         this.round--;
                         document.getElementById('game-round').innerText = this.round;
                         this.progress += 2;
                         this.checkWinCondition();
                         this.showMessage("æ—¶ç©ºå†»ç»“ï¼šå›åˆæ•°ä¸æ¶ˆè€—ï¼Œè¿›åº¦+2", "blue");
                         success = true;
                         break;
                    case 'golden_ticket':
                         this.showMessage("VIP é€šè¡Œè¯ç”Ÿæ•ˆï¼", "green");
                         setTimeout(() => this.showWinModal(), 500);
                         success = true;
                         break;
                }

                if(success) {
                    item.uses--;
                    this.updateGameUI();
                }
            }

            /* --- Poker Logic (Type 4) --- */

            evaluateHand(cards) {
                if (cards.length < 5) return { score: 0, rank: "Cards < 5" };
                
                const sorted = [...cards].sort((a,b) => b.value - a.value);
                
                const counts = {};
                const colorCounts = {};
                sorted.forEach(c => {
                    counts[c.value] = (counts[c.value] || 0) + 1;
                    colorCounts[c.color] = (colorCounts[c.color] || 0) + 1;
                });
                
                const isFlush = Object.values(colorCounts).some(c => c >= 5);
                
                let isStraight = false;
                const uniqueVals = [...new Set(sorted.map(c => c.value))];
                for(let i=0; i<=uniqueVals.length-5; i++) {
                    if (uniqueVals[i] - uniqueVals[i+4] === 4) {
                        isStraight = true;
                        break;
                    }
                }

                const freqValues = Object.values(counts);
                const is4Kind = freqValues.includes(4);
                const is3Kind = freqValues.includes(3);
                const pairCount = freqValues.filter(x => x === 2).length;
                const isFullHouse = is3Kind && pairCount >= 1;

                let rank = 0;
                let rankName = "High Card";

                if (isStraight && isFlush) { rank = 8; rankName = "Straight Flush"; }
                else if (is4Kind) { rank = 7; rankName = "Four of a Kind"; }
                else if (isFullHouse) { rank = 6; rankName = "Full House"; }
                else if (isFlush) { rank = 5; rankName = "Flush"; }
                else if (isStraight) { rank = 4; rankName = "Straight"; }
                else if (is3Kind) { rank = 3; rankName = "Three of a Kind"; }
                else if (pairCount >= 2) { rank = 2; rankName = "Two Pair"; }
                else if (pairCount === 1) { rank = 1; rankName = "Pair"; }

                const score = (rank * 1000000) + sorted[0].value;

                return { score, rankName, bestCards: sorted.slice(0,5) };
            }

            endRound(forced = false) {
                if (this.level.type === 4) {
                    const systemEval = this.evaluateHand(this.systemHand);
                    let win = false;
                    let valid = true;

                    // æ ‡è®°æœ¬å›åˆå·²ç»“æŸï¼ˆç”¨äºç¡¬æ ¸æ¨¡å¼å±•ç¤ºç³»ç»Ÿç‰Œï¼‰
                    if (this.level.hardcore) {
                        this._hardcoreT4Reveal = true;
                    }

                    if (this.roundPlayedCards.length < 5) {
                        this.showMessage("æ‰“å‡ºçš„ç‰Œä¸è¶³5å¼ ï¼Œæœ¬å±€å¤±è´¥", "red");
                        valid = false;
                    } else {
                        const playerEval = this.evaluateHand(this.roundPlayedCards); 
                        if (playerEval.score > systemEval.score) {
                            win = true;
                            this.stats.pokerWins = (this.stats.pokerWins || 0) + 1;
                            this.showMessage(`èƒœåˆ©! ${playerEval.rankName} vs ${systemEval.rankName}`, "green");
                        } else {
                            this.showMessage(`å¤±è´¥! ${playerEval.rankName} vs ${systemEval.rankName}`, "red");
                        }
                    }

                    // Hardcore Betting Logic
                    if (this.level.hardcore) {
                        const bet = this.hardcoreState.t4_bet;
                        if (!valid) win = false;

                        if (win) {
                            this.hardcoreState.t4_s_chips -= bet;
                            this.hardcoreState.t4_p_chips += bet;
                        } else {
                            this.hardcoreState.t4_p_chips -= bet;
                            this.hardcoreState.t4_s_chips += bet;
                        }
                        this.updateHardcoreT4UI();

                        if (this.hardcoreState.t4_p_chips <= 0) {
                            alert("ç­¹ç å½’é›¶ï¼æ¸¸æˆç»“æŸ");
                            this.showMenu();
                            return;
                        }
                        if (this.hardcoreState.t4_s_chips <= 0) {
                            this.showWinModal();
                            return;
                        }

                        // ç¡¬æ ¸æ¨¡å¼ï¼šå±•ç¤ºç³»ç»Ÿæ‰‹ç‰Œï¼Œç­‰å¾…ç©å®¶ç‚¹å‡»"ä¸‹ä¸€å›åˆ"
                        this.updatePokerUI(); // å±•ç¤ºç³»ç»Ÿæ‰‹ç‰Œ
                        document.getElementById('btn-end-round').classList.add('hidden');
                        document.getElementById('btn-next-round').classList.remove('hidden');
                        return;
                    } else {
                         if(win) this.progress++;
                    }

                    this.roundPlayedCards = [];
                }

                if (this.level.hardcore && this.level.type === 5) {
                    this.stopTimerT5();
                }

                this.round++;
                this.hand = [];
                this.discard = [];

                if (this.checkWinCondition()) return;

                if (this.round > this.level.rounds) {
                    this.failLevel();
                } else {
                    this.startRound();
                }
            }

            nextRound() {
                // éšè—"ä¸‹ä¸€å›åˆ"æŒ‰é’®ï¼Œæ˜¾ç¤º"ç»“æŸå›åˆ"æŒ‰é’®
                document.getElementById('btn-next-round').classList.add('hidden');
                document.getElementById('btn-end-round').classList.remove('hidden');

                // æ–°å›åˆå¼€å§‹å‰é‡ç½®ç¡¬æ ¸T4å±•ç¤ºæ ‡è®°
                this._hardcoreT4Reveal = false;

                // ç»§ç»­å›åˆæµç¨‹
                this.round++;
                this.hand = [];
                this.discard = [];

                if (this.checkWinCondition()) return;

                if (this.round > this.level.rounds) {
                    this.failLevel();
                } else {
                    this.startRound();
                }
            }

            checkWinCondition() {
                if (this.progress >= this.level.target) {
                    this.showWinModal();
                    return true;
                }
                return false;
            }

            failLevel() {
                alert("å…³å¡å¤±è´¥ï¼");
                this.showMenu();
            }

            showWinModal() {
                const isFirstClear = !this.completedLevels.includes(this.level.id);
                const isPerfect = !this.usedItem;
                const isSpeedrun = this.round === 1;
                const descEl = document.getElementById('result-desc');
                
                this.stats.totalWins = (this.stats.totalWins || 0) + 1;
                if(isSpeedrun) {
                    this.stats.speedruns = (this.stats.speedruns || 0) + 1;
                    if (!this.stats.speedrunLevelIds) this.stats.speedrunLevelIds = [];
                    if (!this.stats.speedrunLevelIds.includes(this.level.id)) {
                        this.stats.speedrunLevelIds.push(this.level.id);
                    }
                }

                let msg = "ç›®æ ‡è¾¾æˆï¼<br>";
                
                if (isFirstClear) {
                    this.money += this.level.reward;
                    this.completedLevels.push(this.level.id);
                    msg += `<span class="text-green-600 font-bold text-lg">+${this.level.reward} é‡‘å¸</span>`;
                } else {
                    msg += `<span class="text-gray-400 text-xs mt-2 block">(å·²é¢†å–è¿‡é¦–é€šå¥–åŠ±)</span>`;
                }

                if (isPerfect) {
                    if (!this.perfectLevels.includes(this.level.id)) {
                        this.perfectLevels.push(this.level.id);
                        msg += `<div class="mt-2 text-amber-500 font-bold">â­ å®Œç¾é€šå…³ï¼</div>`;
                    } else {
                        msg += `<div class="mt-2 text-amber-500 font-bold text-xs">â­ å®Œç¾é€šå…³</div>`;
                    }
                }

                if (isSpeedrun) {
                     msg += `<div class="mt-1 text-purple-500 font-bold text-xs">âš¡ ç¥é€Ÿè¾¾æˆ</div>`;
                }

                this.saveProgress();
                descEl.innerHTML = msg;
                this.updateMoney();
                document.getElementById('modal-result').classList.remove('hidden');
            }

            finishLevel() {
                document.getElementById('modal-result').classList.add('hidden');
                this.showLevelSelect();
            }

            showMessage(msg, color="red") {
                const el = document.getElementById('game-message');
                el.innerText = msg;
                el.className = `h-6 text-sm font-medium transition-opacity duration-300 opacity-100 ${color === 'green' ? 'text-green-600' : color === 'blue' ? 'text-blue-600' : 'text-red-500'}`;
                setTimeout(() => {
                    el.classList.add('opacity-0');
                }, 2000);
            }

            /* --- Shop Logic --- */

            renderShop() {
                const grid = document.getElementById('shop-grid');
                grid.innerHTML = '';
                
                Object.keys(ITEMS_DB).forEach(key => {
                    const item = ITEMS_DB[key];
                    const isBought = this.boughtItems.includes(key);
                    
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-lg border border-gray-100 flex flex-col justify-between";
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-500 mb-2">${item.desc}</div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded">å¯ç”¨ ${item.maxUses} æ¬¡</span>
                            ${isBought 
                                ? `<button onclick="game.equipItem('${key}')" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded font-bold hover:bg-blue-100">è£…å¤‡</button>` 
                                : `<button onclick="game.buyItem('${key}')" class="text-xs bg-gray-900 text-white px-3 py-1.5 rounded font-bold hover:bg-gray-700">è´­ä¹° ${item.price}ğŸª™</button>`
                            }
                        </div>
                    `;
                    grid.appendChild(div);
                });

                this.renderLoadout();
            }

            renderLoadout() {
                const list = document.getElementById('loadout-list');
                list.innerHTML = '';
                
                this.loadout.forEach((itemId, idx) => {
                    const item = ITEMS_DB[itemId];
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-gray-50 p-2 px-3 rounded text-sm";
                    div.innerHTML = `
                        <span>${item.name}</span>
                        <button onclick="game.unequipItem(${idx})" class="text-red-400 hover:text-red-600">âœ•</button>
                    `;
                    list.appendChild(div);
                });
            }

            buyItem(itemId) {
                const item = ITEMS_DB[itemId];
                if (this.money >= item.price) {
                    this.money -= item.price;
                    this.stats.totalSpent = (this.stats.totalSpent || 0) + item.price;
                    this.boughtItems.push(itemId);
                    this.saveProgress();
                    this.updateMoney();
                    this.renderShop();
                } else {
                    alert("é‡‘é’±ä¸è¶³");
                }
            }

            equipItem(itemId) {
                if (this.loadout.length >= 3) {
                    alert("æœ€å¤šæºå¸¦3ä¸ªé“å…·");
                    return;
                }
                if (this.loadout.includes(itemId)) return;
                this.loadout.push(itemId);
                this.saveProgress();
                this.renderLoadout();
            }

            unequipItem(index) {
                this.loadout.splice(index, 1);
                this.saveProgress();
                this.renderLoadout();
            }

            /* --- UI Rendering --- */

            updateGameUI() {
                document.getElementById('game-round').innerText = this.round;
                document.getElementById('deck-count').innerText = this.deck.length;
                this.updateObjectiveUI();

                if (this.level.type === 4) {
                    this.updatePokerUI();
                }
                
                // Render Last Card
                const slot = document.getElementById('last-card-slot');
                if (this.discard.length > 0) {
                    const card = this.discard[this.discard.length - 1];
                    slot.innerHTML = '';
                    slot.className = `w-24 h-36 rounded-lg shadow-md flex flex-col items-center justify-center transform transition-all border-2 ${this.getCardColorClasses(card)}`;
                    slot.innerHTML = this.getCardInnerHTML(card);
                } else {
                    slot.className = "w-24 h-36 bg-gray-200 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400";
                    slot.innerHTML = "ç©º";
                }

                // Render Hand
                const handEl = document.getElementById('player-hand');
                handEl.innerHTML = '';
                this.hand.forEach((card, idx) => {
                    const el = document.createElement('div');
                    const isPlayable = this.checkPlayable(card);
                    
                    let classes = `card w-20 h-28 rounded-md shadow-sm border flex flex-col items-center justify-center transition-all duration-200 ${this.getCardColorClasses(card)} `;
                    
                    if (card.type === 'void') {
                        classes += ' opacity-50 cursor-not-allowed bg-gray-100 border-gray-300';
                        el.onclick = null;
                    } else if (isPlayable) {
                        classes += ' opacity-100 hover:-translate-y-2 cursor-pointer';
                        el.onclick = () => this.playCard(idx);
                    } else {
                        classes += ' opacity-40 grayscale-[0.3] cursor-not-allowed';
                        el.onclick = () => this.playCard(idx); 
                    }

                    el.className = classes;
                    el.innerHTML = this.getCardInnerHTML(card);
                    
                    el.style.animationDelay = `${idx * 0.05}s`;
                    el.classList.add('animate-slide-in');
                    
                    handEl.appendChild(el);
                });

                // Render Items
                const itemsEl = document.getElementById('active-items');
                itemsEl.innerHTML = '';
                this.activeItems.forEach((item, idx) => {
                    const dbItem = ITEMS_DB[item.id];
                    const btn = document.createElement('button');
                    btn.disabled = item.uses <= 0;
                    btn.className = `px-3 py-1 rounded text-xs font-bold border ${item.uses > 0 ? 'bg-white border-blue-200 text-blue-600 hover:bg-blue-50' : 'bg-gray-100 border-gray-200 text-gray-400'}`;
                    btn.innerText = `${dbItem.name} (${item.uses})`;
                    btn.onclick = () => this.useItem(idx);
                    itemsEl.appendChild(btn);
                });
            }

            checkPlayable(card) {
                if (card.type === 'void') return false;
                if (this.ignoreNextRestriction) return true;
                if (this.discard.length === 0) return true;
                const top = this.discard[this.discard.length-1];
                if (top.type === 'x' || card.type === 'x') return true;
                return (card.color === top.color || Math.abs(card.value - top.value) <= 1);
            }

            updateObjectiveUI() {
                const obj = document.getElementById('game-objective');
                if (this.level.hardcore) {
                    if (this.level.type === 1) obj.innerText = "ç›®æ ‡: å®Œæˆæ‰€æœ‰è¯•ç‚¼";
                    else if (this.level.type === 4) obj.innerText = "ç›®æ ‡: èµ¢å¾—æ‰€æœ‰ç­¹ç ";
                    else if (this.level.type === 5) obj.innerText = `ç›®æ ‡: å­˜æ´»å¹¶æ‰“å‡º ${this.level.target} å¼ ç‰Œ`;
                    else obj.innerText = `è¿›åº¦: ${this.progress} / ${this.level.target}`;
                } else {
                    obj.innerText = `è¿›åº¦: ${this.progress} / ${this.level.target}`;
                }
            }

            updateCounterUI() {
                document.getElementById('counter-val').innerText = this.counter;
                document.getElementById('counter-limit').innerText = this.counterLimit;
                const pct = Math.min(100, (this.counter / this.counterLimit) * 100);
                document.getElementById('counter-bar').style.width = `${pct}%`;
            }

            updatePokerUI() {
                const sysEl = document.getElementById('system-hand');
                sysEl.innerHTML = '';
                this.systemHand.forEach((card, idx) => {
                     const div = document.createElement('div');
                     
                     // Hardcore Type 4: å›åˆä¸­éšè—ç³»ç»Ÿæ‰‹ç‰Œï¼Œå›åˆç»“æŸåå±•ç¤º
                     if (this.level.hardcore && this.level.type === 4) {
                         if (this._hardcoreT4Reveal) {
                             div.className = `w-8 h-12 rounded border text-[10px] flex items-center justify-center ${this.getCardColorClasses(card)}`;
                             div.innerText = card.value;
                         } else {
                             div.className = `w-8 h-12 rounded border bg-gray-800 border-gray-900 flex items-center justify-center`;
                             div.innerHTML = '<span class="text-gray-600">?</span>';
                         }
                     } else {
                         div.className = `w-8 h-12 rounded border text-[10px] flex items-center justify-center ${this.getCardColorClasses(card)}`;
                         div.innerText = card.value;
                     }
                     sysEl.appendChild(div);
                });
                
                const sysEv = this.evaluateHand(this.systemHand);
                if (this.level.hardcore && this.level.type === 4) {
                    document.getElementById('system-score').innerText = this._hardcoreT4Reveal ? `ç³»ç»Ÿ: ${sysEv.rankName}` : 'ç³»ç»Ÿ: ???';
                } else {
                    document.getElementById('system-score').innerText = `ç³»ç»Ÿ: ${sysEv.rankName}`;
                }

                const playEl = document.getElementById('poker-played-hand');
                playEl.innerHTML = '';
                if(this.roundPlayedCards.length === 0) {
                     playEl.innerHTML = '<span class="text-xs text-gray-300 italic py-2">æš‚æ— å‡ºç‰Œ</span>';
                } else {
                    this.roundPlayedCards.forEach(card => {
                        const div = document.createElement('div');
                        div.className = `w-6 h-9 rounded border text-[9px] flex items-center justify-center ${this.getCardColorClasses(card)}`;
                        div.innerHTML = card.type === 'x' ? 'X' : card.value;
                        playEl.appendChild(div);
                    });
                }
                
                const limit = this.level.max_play_count || 5;
                const label = playEl.previousElementSibling;
                if(label) label.innerText = `æœ¬å±€å·²å‡ºç‰Œ (${this.roundPlayedCards.length}/${limit})`;

                if(this.roundPlayedCards.length > 0) {
                     const plEv = this.evaluateHand(this.roundPlayedCards);
                     document.getElementById('poker-player-score').innerText = `å½“å‰: ${plEv.rankName}`;
                } else {
                     document.getElementById('poker-player-score').innerText = '';
                }
            }

            getCardColorClasses(card) {
                if (!card) return '';
                const style = COLOR_MAP[card.color] || COLOR_MAP['void'];
                if (card.type === 'normal') {
                    return `bg-white ${style.border} ${style.text.replace('text-white', '')} border-2`;
                }
                return `${style.bg} ${style.text} border-transparent`;
            }

            getCardInnerHTML(card) {
                if(card.type === 'x') return '<span class="text-xl font-bold">X</span>';
                if(card.type === 'void') return `
                    <div class="text-3xl mb-1 text-gray-300">âˆ…</div>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">VOID</span>
                `;
                
                const colorHex = { 'red': '#f43f5e', 'yellow': '#d97706', 'blue': '#3b82f6', 'green': '#10b981' };
                const c = colorHex[card.color];
                
                return `
                    <div class="font-bold text-2xl" style="color:${c}">${card.value}</div>
                    <div class="absolute bottom-1 right-1 w-3 h-3 rounded-full" style="background-color:${c}"></div>
                    <div class="absolute top-1 left-1 w-3 h-3 rounded-full" style="background-color:${c}"></div>
                `;
            }

            /* --- Hardcore UI Helpers --- */
            updateHardcoreT1UI() {
                const s = this.hardcoreState;
                const el = document.getElementById('mech-hardcore-t1');
                const steps = [
                    { t: "æ‰“å‡º10å¼ ç‰Œ", max: 10 },
                    { t: "æ€»ç‚¹æ•° >= 60", max: 60 },
                    { t: "å·®å€¼ä¸º1 (5æ¬¡)", max: 5 },
                    { t: "ç‚¹æ•°ç›¸åŒ (3æ¬¡)", max: 3 },
                    { t: "åŒ4å€æ•° (5æ¬¡)", max: 5 },
                    { t: "åŒ10ç‚¹ (2æ¬¡)", max: 2 }
                ];
                
                if (s.t1_step >= steps.length) {
                    el.innerHTML = '<div class="text-center text-green-600 font-bold">æ‰€æœ‰æŒ‘æˆ˜å·²å®Œæˆï¼</div>';
                    return;
                }

                const cur = steps[s.t1_step];
                el.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-gray-700">é˜¶æ®µ ${s.t1_step + 1}/6: ${cur.t}</span>
                        <span class="font-mono text-blue-600">${s.t1_progress}/${cur.max}</span>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                        <div class="bg-blue-500 h-full transition-all" style="width: ${(s.t1_progress/cur.max)*100}%"></div>
                    </div>
                `;
            }

            updateHardcoreT4UI() {
                const s = this.hardcoreState;
                document.getElementById('p-chips').innerText = s.t4_p_chips;
                document.getElementById('s-chips').innerText = s.t4_s_chips;
                
                document.getElementById('btn-bet-1').className = `px-4 py-1 rounded font-bold transition ${s.t4_bet === 1 ? 'bg-white text-blue-600 ring-2 ring-blue-500' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`;
                document.getElementById('btn-bet-2').className = `px-4 py-1 rounded font-bold transition ${s.t4_bet === 2 ? 'bg-white text-blue-600 ring-2 ring-blue-500' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`;
            }

            setBet(amount) {
                if(this.level.type === 4 && this.level.hardcore) {
                    this.hardcoreState.t4_bet = amount;
                    this.updateHardcoreT4UI();
                }
            }

            takeDamage(amount, reason) {
                this.hardcoreState.t5_hp -= amount;
                this.updateHardcoreT5UI();
                this.showMessage(`-${amount} HP (${reason})`, "red");
                if (this.hardcoreState.t5_hp <= 1) {
                    this.stopTimerT5();
                    alert("ç”Ÿå‘½å€¼æ¿’å± (<=1)ï¼æ¸¸æˆå¤±è´¥");
                    this.showMenu();
                }
            }

            updateHardcoreT5UI() {
                const s = this.hardcoreState;
                const maxHp = this.level.hp || 10;
                document.getElementById('hp-val').innerText = s.t5_hp;
                document.getElementById('hp-bar').style.width = `${(Math.max(0, s.t5_hp)/maxHp)*100}%`;
                
                document.getElementById('timer-val').innerText = s.t5_time_left.toFixed(1);
                const maxTime = this.level.time_limit || 5;
                document.getElementById('timer-bar').style.width = `${(s.t5_time_left/maxTime)*100}%`;
            }

            startTimerT5() {
                this.stopTimerT5();
                this.hardcoreState.t5_time_left = this.level.time_limit || 5;
                this.updateHardcoreT5UI();
                
                this.hardcoreState.t5_timer = setInterval(() => {
                    this.hardcoreState.t5_time_left -= 0.1;
                    if (this.hardcoreState.t5_time_left <= 0) {
                        this.takeDamage(1, "è¶…æ—¶");
                        this.hardcoreState.t5_time_left = this.level.time_limit || 5;
                    }
                    this.updateHardcoreT5UI();
                }, 100);
            }

            stopTimerT5() {
                if (this.hardcoreState.t5_timer) {
                    clearInterval(this.hardcoreState.t5_timer);
                    this.hardcoreState.t5_timer = null;
                }
            }
        }

        // Initialize
        const game = new Game();

    </script>
</body>
</html>
